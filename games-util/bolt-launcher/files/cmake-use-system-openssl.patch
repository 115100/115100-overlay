From 18832f3cf836f5ee7733f7d71668adcf5cf24a1f Mon Sep 17 00:00:00 2001
From: 115100 <git@three-sigma.org>
Date: Mon, 20 Oct 2025 14:17:42 +0100
Subject: [PATCH] cmake: use system openssl

---
 src/library/CMakeLists.txt  |  5 ++++-
 src/library/plugin/plugin.c | 15 ++++++++++++---
 src/library/plugin/plugin.h |  5 +++++
 3 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/src/library/CMakeLists.txt b/src/library/CMakeLists.txt
index 2abb03cc10af..5472f8f6e178 100644
--- a/src/library/CMakeLists.txt
+++ b/src/library/CMakeLists.txt
@@ -7,7 +7,7 @@ set(LIBRARY_IPC_OS_SPECIFIC "${CMAKE_CURRENT_SOURCE_DIR}/ipc_posix.c" PARENT_SCO
 
 if(UNIX AND NOT APPLE)
     add_library(${BOLT_PLUGIN_LIB_NAME} SHARED so/main.c plugin/plugin.c plugin/plugin_api.c gl.c
-    rwlock/rwlock_posix.c ipc_posix.c plugin/plugin_posix.c ../sha256/sha256.c)
+    rwlock/rwlock_posix.c ipc_posix.c plugin/plugin_posix.c)
 
     find_package(PkgConfig REQUIRED)
 
@@ -17,6 +17,9 @@ if(UNIX AND NOT APPLE)
     pkg_check_modules(MINIZ REQUIRED IMPORTED_TARGET miniz)
     target_link_libraries(${BOLT_PLUGIN_LIB_NAME} PUBLIC PkgConfig::MINIZ)
 
+    pkg_check_modules(OPENSSL REQUIRED IMPORTED_TARGET openssl)
+    target_link_libraries(${BOLT_PLUGIN_LIB_NAME} PUBLIC PkgConfig::OPENSSL)
+
     pkg_check_modules(SPNG REQUIRED IMPORTED_TARGET spng)
     target_link_libraries(${BOLT_PLUGIN_LIB_NAME} PUBLIC PkgConfig::SPNG)
 
diff --git a/src/library/plugin/plugin.c b/src/library/plugin/plugin.c
index 0a13e65d6ffe..598473976d93 100644
--- a/src/library/plugin/plugin.c
+++ b/src/library/plugin/plugin.c
@@ -1,8 +1,13 @@
 #include "../ipc.h"
 
-#include "plugin.h"
 #include "lua.h"
+#include "plugin.h"
 #include "plugin_api.h"
+#if defined(_WIN32)
+#include "../../sha256/sha256.h"
+#else
+#include "openssl/sha.h"
+#endif
 
 #include <hashmap.h>
 #include <lauxlib.h>
@@ -51,7 +56,7 @@ static uint8_t capture_inited;
 static uint64_t last_mouseevent_window_id = 0;
 static uint64_t grabbed_window_id = 0;
 
-static char character_hash[SHA256_BLOCK_SIZE * 2] = {0};
+static char character_hash[CHARHASHSIZE] = {0};
 
 // called mainly from the input thread - see comment in header for thread-safety observations
 uint64_t _bolt_plugin_get_last_mouseevent_windowid() { return last_mouseevent_window_id; }
@@ -267,11 +272,15 @@ void _bolt_plugin_init(const struct PluginManagedFunctions* functions) {
         _bolt_ipc_send(fd, character_id, id_len);
     }
 
-    SHA256_CTX ctx;
     unsigned char hash[SHA256_BLOCK_SIZE];
+#if defined(_WIN32)
+    SHA256_CTX ctx;
     sha256_init(&ctx);
     sha256_update(&ctx, (const unsigned char*)character_id, character_id ? strlen(character_id) : 0);
     sha256_final(&ctx, hash);
+#else
+    SHA256((const unsigned char*)character_id, character_id ? strlen(character_id) : 0, hash);
+#endif
     for (size_t i = 0; i < SHA256_BLOCK_SIZE; i += 1) {
         character_hash[i * 2] = u4_to_char((hash[i] >> 4) & 0b1111);
         character_hash[(i * 2) + 1] = u4_to_char(hash[i] & 0b1111);
diff --git a/src/library/plugin/plugin.h b/src/library/plugin/plugin.h
index 552ad77c7331..99a2889d17c0 100644
--- a/src/library/plugin/plugin.h
+++ b/src/library/plugin/plugin.h
@@ -8,7 +8,12 @@
 #include "../rwlock/rwlock.h"
 #include "../event.h"
 
+#if defined(_WIN32)
 #include "../../sha256/sha256.h"
+#else
+#include "openssl/sha.h"
+#define SHA256_BLOCK_SIZE SHA256_DIGEST_LENGTH
+#endif
 #define CHARHASHSIZE (SHA256_BLOCK_SIZE * 2)
 
 #define GRAB_TYPE_NONE 0
-- 
2.52.0

