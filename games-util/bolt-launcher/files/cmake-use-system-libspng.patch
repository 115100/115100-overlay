From 6365cc827dcf9befff14307b2a1c4619e18243fe Mon Sep 17 00:00:00 2001
From: 115100 <git@three-sigma.org>
Date: Wed, 2 Jul 2025 17:02:37 +0100
Subject: [PATCH] cmake: use system libspng

---
 CMakeLists.txt                  | 9 ++++++++-
 icon/generator.cxx              | 5 ++---
 src/library/CMakeLists.txt      | 6 ++++--
 src/library/plugin/plugin_api.c | 3 +--
 4 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 82cdcd7f9488..cd4da6714914 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -432,7 +432,14 @@ endif()
 
 # compile an auto-generator, then use it to auto-generate a C++ file containing icon data
 set(BOLT_ICON_DIR "${CMAKE_CURRENT_SOURCE_DIR}/icon")
-add_executable(icon_gen icon/generator.cxx modules/spng/spng/spng.c src/miniz/miniz.c)
+add_executable(icon_gen icon/generator.cxx src/miniz/miniz.c)
+if(UNIX AND NOT APPLE)
+    find_package(PkgConfig REQUIRED)
+    pkg_check_modules(SPNG REQUIRED IMPORTED_TARGET spng)
+    target_link_libraries(icon_gen PUBLIC PkgConfig::SPNG)
+elseif(WIN32)
+    add_executable(icon_gen modules/spng/spng/spng.c)
+endif()
 target_include_directories(icon_gen PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/src/miniz")
 target_compile_definitions(icon_gen PUBLIC SPNG_STATIC=1 SPNG_USE_MINIZ=1)
 set_target_properties(icon_gen PROPERTIES CXX_STANDARD 20 CXX_EXTENSIONS OFF)
diff --git a/icon/generator.cxx b/icon/generator.cxx
index 7d9de1c79f2e..b59d698e7833 100644
--- a/icon/generator.cxx
+++ b/icon/generator.cxx
@@ -1,7 +1,6 @@
-#include "../modules/spng/spng/spng.h"
-
-#include <iostream>
 #include <fstream>
+#include <iostream>
+#include <spng.h>
 #include <sstream>
 #include <string.h>
 
diff --git a/src/library/CMakeLists.txt b/src/library/CMakeLists.txt
index 4cc21e97b64b..ea0d05b39ab5 100644
--- a/src/library/CMakeLists.txt
+++ b/src/library/CMakeLists.txt
@@ -7,14 +7,16 @@ set(LIBRARY_IPC_OS_SPECIFIC "${CMAKE_CURRENT_SOURCE_DIR}/ipc_posix.c" PARENT_SCO
 
 if(UNIX AND NOT APPLE)
     add_library(${BOLT_PLUGIN_LIB_NAME} SHARED so/main.c plugin/plugin.c plugin/plugin_api.c gl.c
-    rwlock/rwlock_posix.c ipc_posix.c plugin/plugin_posix.c
-    ../miniz/miniz.c ../sha256/sha256.c ../../modules/spng/spng/spng.c)
+    rwlock/rwlock_posix.c ipc_posix.c plugin/plugin_posix.c ../miniz/miniz.c ../sha256/sha256.c)
 
     find_package(PkgConfig REQUIRED)
 
     pkg_check_modules(LUAJIT REQUIRED IMPORTED_TARGET luajit)
     target_link_libraries(${BOLT_PLUGIN_LIB_NAME} PUBLIC PkgConfig::LUAJIT)
 
+    pkg_check_modules(SPNG REQUIRED IMPORTED_TARGET spng)
+    target_link_libraries(${BOLT_PLUGIN_LIB_NAME} PUBLIC PkgConfig::SPNG)
+
     target_link_libraries(${BOLT_PLUGIN_LIB_NAME} PUBLIC hashmap)
 
     target_include_directories(${BOLT_PLUGIN_LIB_NAME} PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/../miniz")
diff --git a/src/library/plugin/plugin_api.c b/src/library/plugin/plugin_api.c
index 8dec789bd782..fe8d310d98fc 100644
--- a/src/library/plugin/plugin_api.c
+++ b/src/library/plugin/plugin_api.c
@@ -3,11 +3,10 @@
 #include "lua.h"
 #include "plugin.h"
 
-#include "../../../modules/spng/spng/spng.h"
-
 #include <hashmap.h>
 #include <lauxlib.h>
 #include <math.h>
+#include <spng.h>
 #include <string.h>
 #include <time.h>
 
-- 
2.51.0

